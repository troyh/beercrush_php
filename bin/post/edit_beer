#!/bin/bash
EDIT_FILE=$1
XML_DIR="/home/troy/beerliberation/xml/beer"
HTML_DIR="/home/troy/beerliberation/app/html/beer"

WWWDOCROOT=/var/www/beer 
WWWRELPATH=/html/beer/

# Clean up the data (remove extraneous spaces, etc.)

# Do verification on the data

MY_DIR=`dirname $0`;

ID=`xmlstarlet sel -t -v "/post/doc/edit_beer/id" $EDIT_FILE`
XML_FILE="$XML_DIR/$ID.xml";

UPDATES="";
ADDS="";
DELETES="";

# Get all the fields to edit
cat $EDIT_FILE | xmlstarlet sel -t -m "/post/doc/edit_beer/*[name()!='id']" -v "name()" -o "&#09;" -v . -n | sed -e'/^\s*$/d' > /tmp/edit_beer-$$.out

while read TAG VAL; do
	XPATH="";
	ELEM="";
	ATTR="";
	
	if   [ $TAG == "name"     		]; then XPATH="/beer"; ELEM="name";
	elif [ $TAG == "description"	]; then XPATH="/beer"; ELEM="description";
	elif [ $TAG == "abv"			]; then XPATH="/beer"; ELEM="abv";
	elif [ $TAG == "bjcp_style_id"	]; then XPATH="/beer"; ATTR="bjcp_style_id";
	elif [ $TAG == "brewery_id"		]; then XPATH="/beer"; ATTR="brewery_id";
	fi
	
	if [ -n "$ELEM" ]; then

		COUNT=`xmlstarlet sel -t -v "$XPATH/*[name()='$ELEM']" -n $XML_FILE | sed -e'$d' | wc -l`;
		
		if [ $COUNT -gt 0 ]; then
			# Update it
			UPDATES="$UPDATES --update \"$XPATH/$ELEM\" -v \"$VAL\"";
		else
			# Add the element
			ADDS="$ADDS --subnode \"$XPATH\" -t elem -n \"$ELEM\" -v \"$VAL\"";
		fi
	elif [ -n "$ATTR" ]; then
		COUNT=`xmlstarlet sel -t -v "$XPATH/@$ATTR" -n $XML_FILE | sed -e'$d' | wc -l`;
		
		if [ $COUNT -gt 0 ]; then
			# Update it
			UPDATES="$UPDATES --update \"$XPATH/@$ATTR\" -v \"$VAL\"";
		else
			# Add the element
			ADDS="$ADDS --append \"$XPATH\" -t attr -n \"$ATTR\" -v \"$VAL\"";
		fi
	fi
	
done < /tmp/edit_beer-$$.out

echo xmlstarlet ed $DELETES $UPDATES $ADDS $XML_FILE | sh > $XML_FILE.new
if [ -s $XML_FILE.new ]; then
	mv $XML_FILE.new $XML_FILE
else
	echo "Content-Type: text/plain";
	echo;
	echo Failed: xmlstarlet ed $DELETES $UPDATES $ADDS $XML_FILE
	exit;
fi

# Generate the HTML file
# WWWDOCROOT=$WWWDOCROOT WWWRELPATH=$WWWRELPATH make -C $HTML_DIR $ID.html

# Check the doc into SVN

# Output new XML file as the response
echo "Content-Type: text/xml";
echo;
cat $XML_FILE
