#!/bin/bash
EDIT_FILE=$1
XML_DIR="/home/troy/beerliberation/xml/brewery"
HTML_DIR="/home/troy/beerliberation/app/html/brewery"

WWWDOCROOT=/var/www/beer 
WWWRELPATH=/html/brewery/

# Clean up the data (remove extraneous spaces, etc.)

# Do verification on the data

MY_DIR=`dirname $0`;

ID=`xmlstarlet sel -t -v "/post/doc/edit_brewery/id" $EDIT_FILE`
XML_FILE="$XML_DIR/$ID.xml";

UPDATES="";
ADDS="";
DELETES="";

# Get all the fields to edit
cat $EDIT_FILE | xmlstarlet sel -t -m "/post/doc/edit_brewery/*[name()!='id']" -v "name()" -o "&#09;" -v . -n | sed -e'/^\s*$/d' > /tmp/edit_brewery-$$.out

while read TAG VAL; do
	XPATH="";
	
	if   [ $TAG == "uri"     ]; then XPATH="/brewery"; ELEM="uri";
	elif [ $TAG == "name"    ]; then XPATH="/brewery"; ELEM="name";
	elif [ $TAG == "phone"   ]; then XPATH="/brewery"; ELEM="phone";
	elif [ $TAG == "street"  ]; then XPATH="/brewery/address"; ELEM="street";
	elif [ $TAG == "city"    ]; then XPATH="/brewery/address"; ELEM="city";
	elif [ $TAG == "state"   ]; then XPATH="/brewery/address"; ELEM="state";
	elif [ $TAG == "country" ]; then XPATH="/brewery/address"; ELEM="country";
	elif [ $TAG == "zip"     ]; then XPATH="/brewery/address"; ELEM="zip";
	fi
	
	if [ -n "$XPATH" ]; then

		COUNT=`xmlstarlet sel -t -v "$XPATH/*[name()='$ELEM']" -n $XML_FILE | sed -e'$d' | wc -l`;
		
		if [ $COUNT -gt 0 ]; then
			if [ $TAG == "street" ]; then
				# There can be multiple streets, so erase all existing ones and add all new ones
				DELETES="--delete \"$XPATH/$ELEM\"";
				ADDS="$ADDS --subnode \"$XPATH\" -t elem -n \"$ELEM\" -v \"$VAL\"";
			fi
			# Update it
			UPDATES="$UPDATES --update \"$XPATH/$ELEM\" -v \"$VAL\"";
		else
			# Add the element
			ADDS="$ADDS --subnode \"$XPATH\" -t elem -n \"$ELEM\" -v \"$VAL\"";
		fi
	fi
	
done < /tmp/edit_brewery-$$.out

echo xmlstarlet ed $DELETES $UPDATES $ADDS $XML_FILE | sh > $XML_FILE.new
if [ -s $XML_FILE.new ]; then
	mv $XML_FILE.new $XML_FILE
else
	echo "Content-Type: text/plain";
	echo;
	echo Failed: xmlstarlet ed $DELETES $UPDATES $ADDS $XML_FILE
	exit;
fi

# Generate the HTML file
# WWWDOCROOT=$WWWDOCROOT WWWRELPATH=$WWWRELPATH make -C $HTML_DIR $ID.html

# Check the doc into SVN

# Output new XML file as the response
echo "Content-Type: text/xml";
echo;
cat $XML_FILE
