#!/usr/bin/php
<?php
require_once('beercrush/beercrush.php');
require_once('OAK/jobs.class.php');

$oak=new OAK(BeerCrush::CONF_FILE);
$oakjobs=new OAKJobs($oak,'docchanges');
$oakjobs->set_message_callback('handle_docchange');
$oakjobs->gimme_jobs('do_nothing'); // We don't care, we're just using OAKJobs to easily get every message

function handle_docchange($oakjobs,$docid) {
	$oakjobs->getOAK()->log('Document changed:'.$docid);

	$docmap=array(
		// Document -> APIs
		array('beer:(.+):(.+)'							, array('/api/beer/$1/$2','/api/brewery/$1/beerlist')),
		array('brewery:(.+)'  							, '/api/brewery/$1'),
		array('place:(.+)'    							, '/api/place/$1'),
		array('review:beer:(.+):(.+):(.+)'				, '/api/review/beer/$1/$2/$3/0',
		array('review:(brewery|place):(.+):(.+)'		, '/api/review/$1/$2/$3/0',
		array('user:(.+)'     							, '/api/user/$1'),
		array('photoset:(.+):(.+):(.+)'					, '/api/photoset/$1/$2/$3'),
		array('flavors'									, '/api/flavors'),
		// API -> Pages
		array('/api/beer/(.+)/(.+)'							, array('/beer/$1/$2','/brewery/$1/beerlist')),
		array('/api/brewery/(.+)'							, '/brewery/$1'),
		array('/api/brewery/(.+)/beerlist'					, '/brewery/$1'),
		array('/api/place/(.+)'								, '/place/$1'),
		array('/api/review/(beer|brewery|place)/(.+)/(.+)'	, '/$1/$2/$3'),
		array('/api/user/(.+)'								, '/user/$1'),
		array('/api/photoset/(beer|brewery|place)/(.+)/(.+)', '/$1/$2/$3'),
	);

	foreach ($docmap as $map) {
		if (!is_array($map[1]))
			$map[1]=array($map[1]);
			
		foreach ($map[1] as $replacement) {
			$new_url=preg_replace('/'.str_replace('/','\\/',$map[0]).'/',$replacement,$url);
			if ($new_url!=$url) {
				$oakjobs->getOAK()->purge_document_cache($new_url);
				$oakjobs->getOAK()->broadcast_msg('docchanges',$new_url);
			}
		}
	}
}

function do_nothing($oakjobs,$job) {
	return TRUE;
}

?>